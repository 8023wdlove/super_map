import{a as j}from"./chunk-K6FM2O3N.js";import{a as f}from"./chunk-TW5GUTQO.js";import{a as S}from"./chunk-PJGSCWXZ.js";import{a as c}from"./chunk-NUC3LT2W.js";import"./chunk-SFC4FDPW.js";var v={NONE:0,STORING:1,STORED:2,FAILED:3};function d(t){if(!c(t.name))throw new S("options.name is required.");var r=f.defer();this.dbname=t.name;var e=indexedDB.open(this.dbname),s=this;return e.onsuccess=function(n){s.db=n.target.result,s.version=s.db.version,c(s.cachestatus)||(s.cachestatus={}),r.resolve(s)},e.onupgradeneeded=function(n){s.db=n.target.result,s.version=s.db.version,r.resolve(s)},e.onerror=function(n){s.db=null,r.reject("create database fail, error code : "+n.target.errorcode)},this.layer=t.layer||null,this.storageType=t.storageType||"arrayBuffer",this.creatingTable=!1,this.cachestatus={},r.promise}d.prototype.checkObjectStoreExit=function(t){return c(this.db)?this.db.objectStoreNames.contains(t):!1};d.prototype.createObjectStore=function(t){var r=f.defer();if(this.creatingTable)r.reject(!1);else{if(this.db.objectStoreNames.contains(t))return r.reject(!1),r.promise;this.creatingTable=!0;var e=this,s=parseInt(e.db.version);e.db.close();var n=indexedDB.open(e.dbname,s+1);n.onupgradeneeded=function(i){var o=i.target.result;e.db=o;var u=o.createObjectStore(t,{keyPath:"id"});if(c(u)){u.createIndex("value","value",{unique:!1}),c(e.cachestatus)||(e.cachestatus={}),e.cachestatus[t]={};var a=indexedDB.open(e.dbname,s+2);a.onsuccess=function(l){e.creatingTable=!1;var p=l.target.result;e.db=p,r.resolve(!0)}}else e.creatingTable=!1,r.reject(!1)},n.onsuccess=function(i){e.creatingTable=!1,i.target.result.close(),r.resolve(!0)},n.onerror=function(i){e.creatingTable=!1,r.reject(!1)}}return r.promise};d.prototype.putElementInDB=function(t,r,e,s){var n=f.defer();if(!c(this.db))return n.reject(!1),n.promise;var i,o=this;if(c(o.cachestatus[t])&&!c(s)&&c(o.cachestatus[t][r])&&(o.cachestatus[t][r]===v.STORING||o.cachestatus[t][r]===v.STORED))return n.resolve(!1),n.promise;if(!this.db.objectStoreNames.contains(t))this.createObjectStore(t).then(function(h){var T=o.db.transaction([t],"readwrite");if(i=T.objectStore(t),c(s)){for(var b=0,E=s.length;b<E;b++)i.add({id:s[b].key,value:s[b].value});n.resolve(!0)}else{var g=i.add({id:r,value:e});g.onsuccess=function(B){n.resolve(!0)},g.onerror=function(B){n.reject(!1)}}},function(h){n.reject(!1)});else{c(o.cachestatus[t])||(o.cachestatus[t]={});var u;try{u=this.db.transaction([t],"readwrite")}catch{return n.reject(null),n.promise}if(i=u.objectStore(t),c(s))if(s instanceof Array){for(var a=0,l=s.length;a<l;a++)o.cachestatus[t][s[a].key]!==v.STORED&&(i.add({id:s[a].key,value:s[a].value}),o.cachestatus[t][s[a].key]=v.STORED);n.resolve(!0)}else{for(var r in s)isNaN(r*1)||i.add({id:r,value:s[r]});n.resolve(!0)}else{if(!c(r)||!c(e))return;if(r instanceof Array&&e instanceof Array){for(var a=0,l=r.length;a<l;a++)o.cachestatus[t][r[a]]!==v.STORED&&(i.add({id:r[a],value:e[a]}),o.cachestatus[t][r[a]]=v.STORED);u.oncomplete=function(h){n.resolve(!0)},u.onerror=function(h){n.reject(!1)}}else{var p=i.add({id:r,value:e});o.cachestatus[t][r]=v.STORING,p.onsuccess=function(h){o.cachestatus[t][r]=v.STORED,n.resolve(!0)},p.onerror=function(h){o.cachestatus[t][r]=v.FAILED,n.reject(!1)}}}}return n.promise};d.prototype.getRangeFromDB=function(t,r){var e=f.defer();if(!c(this.db)||!this.db.objectStoreNames.contains(t))return null;var s;try{s=this.db.transaction([t])}catch{return e.reject(null),e.promise}var n;try{n=s.objectStore(t)}catch{e.reject(null)}var i=n.openCursor(IDBKeyRange.bound(r[0],r[1])),o=[];return i.onsuccess=function(u){var a=u.target.result;c(a)?(o.push(a.value),a.continue()):e.resolve(o)},i.onerror=function(u){e.reject(null)},e.promise};d.prototype.getElementFromDB=function(t,r){var e=f.defer();if(!c(this.db)||!this.db.objectStoreNames.contains(t))return null;var s;try{s=this.db.transaction([t])}catch{return e.reject(null),e.promise}var n;try{n=s.objectStore(t)}catch{e.reject(null)}var i=n.get(r);return i.onsuccess=function(o){if(!c(o.target.result)){e.reject(null);return}e.resolve(o.target.result.value)},i.onerror=function(o){e.reject(null)},e.promise};d.prototype.getAllElementFromDB=function(t){var r=f.defer();if(!c(this.db)||!this.db.objectStoreNames.contains(t))return null;var e;if(this.transaction!=null)e=this.transaction;else try{e=this.db.transaction([t])}catch{return r.reject(null),r.promise}var s;try{s=e.objectStore(t)}catch{r.reject(null)}var n=s.getAll();return n.onsuccess=function(i){if(!c(i.target.result)){r.reject(null);return}r.resolve(i.target.result)},n.onerror=function(i){r.reject(null)},r.promise};d.prototype.updateElementInDB=function(t,r,e,s){var n=f.defer();if(!c(this.db)||!this.db.objectStoreNames.contains(t))return n.resolve(!1),n.promise;var i=this.db.transaction([t],"readwrite"),o;try{o=i.objectStore(t)}catch{n.resolve(!1)}var u=o.get(r);return u.onsuccess=function(a){var l=a.target.result;c(l)||(l={id:r}),s===!0?l.value=Object.assign(l.value,e):l.value=e;var p=o.put(l);p.onsuccess=function(h){n.resolve(!0)},p.onerror=function(h){n.resolve(!1)}},u.onerror=function(a){n.resolve(!1)},n.promise};d.prototype.removeElementFromDB=function(t,r){var e=f.defer();if(!c(this.db)||!this.db.objectStoreNames.contains(t))return e.resolve(!1),e.promise;var s=this.db.transaction([t],"readwrite"),n;try{n=s.objectStore(t)}catch{e.resolve(!1)}var i=n.delete(r);return i.onerror=function(o){e.resolve(!1)},i.onsuccess=function(o){e.resolve(!0)},e.promise};d.prototype.clear=function(t){var r=f.defer();if(!c(this.db)||!this.db.objectStoreNames.contains(t))return r.resolve(!1),r.promise;var e=this.db.transaction([t],"readwrite"),s;try{s=e.objectStore(t)}catch{r.resolve(!1)}var n=s.clear();return n.onerror=function(i){r.resolve(!1)},n.onsuccess=function(i){r.resolve(!0)},r.promise};var D=d;var m={},O=50;function I(t,r){var e=t.blob,s=t.key;if(typeof e<"u"&&typeof s<"u"){var n=t.tablename,i=t.dbname,o=i+n;typeof m[o]>"u"&&(m[o]={cache:[],creatingDB:!1,scheduler:null,creatingTable:!1});var u=O;typeof t.reserveCount<"u"&&(u=t.reserveCount),m[o].cache.length<u&&m[o].cache.push({key:s,value:e})}else for(var a=t.nameArray,l=0;l<a.length;l++){var n=a[l].tablename,i=a[l].dbname,o=i+n;typeof m[o]<"u"&&Object.keys(m[o].cache).length!==0&&N(i,n,m[o])}}function N(t,r,e){e.scheduler===null?e.creatingDB||(e.creatingDB=!0,new D({name:t}).then(function(s){e.creatingDB=!1,e.scheduler=s,s.checkObjectStoreExit(r)?(s.putElementInDB(r,null,null,e.cache),e.cache=[]):e.creatingTable||(e.creatingTable=!0,s.createObjectStore(r).then(function(){e.creatingTable=!1,s.putElementInDB(r,null,null,e.cache),e.cache=[]}))})):e.scheduler.checkObjectStoreExit(r)?(e.scheduler.putElementInDB(r,null,null,e.cache),e.cache=[]):e.creatingTable||(e.creatingTable=!0,e.scheduler.createObjectStore(r).then(function(){e.creatingTable=!1,e.scheduler.putElementInDB(r,null,null,e.cache),e.cache=[]}))}var C=j(I);export{C as default};
